// Copyright (c) 2022 Arm Limited
// Copyright (c) 2022 Hanno Becker
// Copyright (c) 2023 Amin Abdulrahman, Matthias Kannwischer
// Copyright (c) 2024 The mlkem-native project authors
// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: MIT

// ----------------------------------------------------------------------------
// Inverse number-theoretic transform from ML-KEM
// Input a[256], z_01234[80], z_56[384] (all signed 16-bit words); output a[256] (signed 16-bit words).
//
// The transform is in-place with input and output a[256], with the input in
// bitreversed order and the output mapped into the Montgomery domain via
// x |-> (2^16 * x) mod 3329. The two other parameters are expected to point to
// tables of constants whose definitions can be found in the mlkem-native
// repo (mlkem/native/aarch64/src/aarch64_zetas.c) or our "tests/test.c".
//
// extern void mlkem_intt(int16_t a[256],int16_t z_01234[80],int16_t z_56[384]);
//
// Standard ARM ABI: X0 = a, X1 = z_01234, X2 = z_56
// ----------------------------------------------------------------------------
#include "_internal_s2n_bignum.h"

        S2N_BN_SYM_VISIBILITY_DIRECTIVE(mlkem_intt)
        S2N_BN_SYM_PRIVACY_DIRECTIVE(mlkem_intt)
        .text
        .balign 4

S2N_BN_SYMBOL(mlkem_intt):

// This implementation is generated by SLOTHY, set up to optimize for
// the Neoverse N1 microarchitecture, starting from the clean version
//
//   https://github.com/pq-code-package/mlkem-native/blob/main/mlkem/native/aarch64/intt_clean.S
//
// in the mlkem-native repository.

        sub     sp, sp, #0x40
        stp     d8, d9, [sp]
        stp     d10, d11, [sp, #16]
        stp     d12, d13, [sp, #32]
        stp     d14, d15, [sp, #48]
        mov     w5, #0xd01
        mov     v7.h[0], w5
        mov     w5, #0x4ebf
        mov     v7.h[1], w5
        mov     w5, #0x200
        dup     v29.8h, w5
        mov     w5, #0x13b0
        dup     v30.8h, w5
        mov     x3, x0
        mov     x4, #0x8

scale_start:
        ldr     q8, [x3]
        ldr     q9, [x3, #16]
        ldr     q10, [x3, #32]
        ldr     q11, [x3, #48]
        sqrdmulh        v27.8h, v8.8h, v30.8h
        mul     v8.8h, v8.8h, v29.8h
        mls     v8.8h, v27.8h, v7.h[0]
        sqrdmulh        v27.8h, v9.8h, v30.8h
        mul     v9.8h, v9.8h, v29.8h
        mls     v9.8h, v27.8h, v7.h[0]
        sqrdmulh        v27.8h, v10.8h, v30.8h
        mul     v10.8h, v10.8h, v29.8h
        mls     v10.8h, v27.8h, v7.h[0]
        sqrdmulh        v27.8h, v11.8h, v30.8h
        mul     v11.8h, v11.8h, v29.8h
        mls     v11.8h, v27.8h, v7.h[0]
        str     q8, [x3], #64
        stur    q9, [x3, #-48]
        stur    q10, [x3, #-32]
        stur    q11, [x3, #-16]
        subs    x4, x4, #0x1
        cbnz    x4, scale_start
        mov     x3, x0
        mov     x4, #0x8
        ldr     q23, [x3, #48]
        ldr     q28, [x3, #32]
        ldr     q13, [x3, #16]
        ldr     q4, [x3]
        ldr     q25, [x2, #48]
        ldr     q16, [x2, #80]
        ldr     q12, [x1], #16
        trn2    v22.4s, v28.4s, v23.4s
        trn1    v29.4s, v28.4s, v23.4s
        trn1    v6.4s, v4.4s, v13.4s
        trn2    v18.4s, v4.4s, v13.4s
        trn2    v30.2d, v6.2d, v29.2d
        trn2    v3.2d, v18.2d, v22.2d
        trn1    v5.2d, v6.2d, v29.2d
        ldr     q9, [x2, #64]
        sub     v20.8h, v30.8h, v3.8h
        trn1    v27.2d, v18.2d, v22.2d
        add     v0.8h, v30.8h, v3.8h
        sqrdmulh        v15.8h, v20.8h, v16.8h
        add     v22.8h, v5.8h, v27.8h
        sub     v19.8h, v5.8h, v27.8h
        mul     v30.8h, v20.8h, v9.8h
        ldr     q17, [x2, #32]
        ldr     q9, [x2], #96
        sqrdmulh        v5.8h, v19.8h, v25.8h
        sub     v18.8h, v22.8h, v0.8h
        mls     v30.8h, v15.8h, v7.h[0]
        mul     v26.8h, v19.8h, v17.8h
        mls     v26.8h, v5.8h, v7.h[0]
        ldur    q5, [x2, #-80]
        mul     v14.8h, v18.8h, v9.8h
        sqrdmulh        v28.8h, v18.8h, v5.8h
        sub     v17.8h, v26.8h, v30.8h
        add     v21.8h, v26.8h, v30.8h
        add     v26.8h, v22.8h, v0.8h
        sqrdmulh        v5.8h, v17.8h, v5.8h
        trn2    v20.4s, v26.4s, v21.4s
        mls     v14.8h, v28.8h, v7.h[0]
        mul     v17.8h, v17.8h, v9.8h
        mls     v17.8h, v5.8h, v7.h[0]
        trn1    v18.4s, v26.4s, v21.4s
        trn2    v5.4s, v14.4s, v17.4s
        trn1    v16.4s, v14.4s, v17.4s
        trn2    v26.2d, v20.2d, v5.2d
        trn2    v30.2d, v18.2d, v16.2d
        trn1    v31.2d, v20.2d, v5.2d
        add     v8.8h, v30.8h, v26.8h
        sub     v25.8h, v30.8h, v26.8h
        trn1    v26.2d, v18.2d, v16.2d
        sqdmulh v5.8h, v8.8h, v7.h[1]
        sub     v29.8h, v26.8h, v31.8h
        add     v22.8h, v26.8h, v31.8h
        sqrdmulh        v20.8h, v29.8h, v12.h[3]
        srshr   v13.8h, v5.8h, #11
        sqdmulh v31.8h, v22.8h, v7.h[1]
        sub     x4, x4, #0x1

layer4567_start:
        sqrdmulh        v28.8h, v25.8h, v12.h[5]
        ldr     q24, [x2, #48]
        ldr     q3, [x3, #96]
        ldr     q15, [x2, #80]
        ldr     q23, [x3, #112]
        mul     v10.8h, v25.8h, v12.h[4]
        ldr     q14, [x3, #64]
        ldr     q4, [x3, #80]
        mls     v8.8h, v13.8h, v7.h[0]
        ldr     q13, [x2, #64]
        ldr     q5, [x2], #96
        srshr   v17.8h, v31.8h, #11
        trn1    v0.4s, v3.4s, v23.4s
        mul     v27.8h, v29.8h, v12.h[2]
        trn1    v30.4s, v14.4s, v4.4s
        trn2    v26.4s, v14.4s, v4.4s
        mls     v27.8h, v20.8h, v7.h[0]
        trn2    v21.2d, v30.2d, v0.2d
        trn2    v11.4s, v3.4s, v23.4s
        mls     v10.8h, v28.8h, v7.h[0]
        trn1    v23.2d, v30.2d, v0.2d
        ldur    q3, [x2, #-80]
        mls     v22.8h, v17.8h, v7.h[0]
        trn1    v31.2d, v26.2d, v11.2d
        trn2    v16.2d, v26.2d, v11.2d
        add     v14.8h, v23.8h, v31.8h
        sqdmulh v4.8h, v27.8h, v7.h[1]
        ldur    q26, [x2, #-64]
        add     v28.8h, v21.8h, v16.8h
        sub     v25.8h, v21.8h, v16.8h
        sqdmulh v21.8h, v10.8h, v7.h[1]
        sub     v1.8h, v14.8h, v28.8h
        mul     v29.8h, v25.8h, v13.8h
        add     v2.8h, v14.8h, v28.8h
        srshr   v9.8h, v4.8h, #11
        sub     v11.8h, v23.8h, v31.8h
        sqrdmulh        v19.8h, v1.8h, v3.8h
        add     v31.8h, v22.8h, v8.8h
        sqrdmulh        v13.8h, v11.8h, v24.8h
        str     q31, [x3], #64
        sqrdmulh        v30.8h, v25.8h, v15.8h
        mul     v0.8h, v11.8h, v26.8h
        mls     v0.8h, v13.8h, v7.h[0]
        sub     v13.8h, v22.8h, v8.8h
        srshr   v22.8h, v21.8h, #11
        mls     v29.8h, v30.8h, v7.h[0]
        mls     v27.8h, v9.8h, v7.h[0]
        mls     v10.8h, v22.8h, v7.h[0]
        mul     v9.8h, v1.8h, v5.8h
        sub     v28.8h, v0.8h, v29.8h
        sqrdmulh        v8.8h, v28.8h, v3.8h
        add     v26.8h, v27.8h, v10.8h
        mul     v20.8h, v28.8h, v5.8h
        sub     v17.8h, v27.8h, v10.8h
        add     v10.8h, v0.8h, v29.8h
        stur    q26, [x3, #-48]
        mls     v9.8h, v19.8h, v7.h[0]
        mls     v20.8h, v8.8h, v7.h[0]
        trn2    v25.4s, v2.4s, v10.4s
        trn1    v8.4s, v2.4s, v10.4s
        sqrdmulh        v4.8h, v13.8h, v12.h[1]
        mul     v0.8h, v13.8h, v12.h[0]
        trn1    v10.4s, v9.4s, v20.4s
        trn2    v26.4s, v9.4s, v20.4s
        sqrdmulh        v14.8h, v17.8h, v12.h[1]
        trn2    v11.2d, v8.2d, v10.2d
        mul     v2.8h, v17.8h, v12.h[0]
        trn1    v28.2d, v25.2d, v26.2d
        ldr     q12, [x1], #16
        trn2    v25.2d, v25.2d, v26.2d
        trn1    v10.2d, v8.2d, v10.2d
        mls     v0.8h, v4.8h, v7.h[0]
        add     v8.8h, v11.8h, v25.8h
        mls     v2.8h, v14.8h, v7.h[0]
        sub     v25.8h, v11.8h, v25.8h
        sub     v29.8h, v10.8h, v28.8h
        add     v22.8h, v10.8h, v28.8h
        sqdmulh v16.8h, v8.8h, v7.h[1]
        stur    q0, [x3, #-32]
        sqrdmulh        v20.8h, v29.8h, v12.h[3]
        stur    q2, [x3, #-16]
        sqdmulh v31.8h, v22.8h, v7.h[1]
        srshr   v13.8h, v16.8h, #11
        sub     x4, x4, #0x1
        cbnz    x4, layer4567_start

        srshr   v6.8h, v31.8h, #11
        sqrdmulh        v11.8h, v25.8h, v12.h[5]
        mul     v18.8h, v25.8h, v12.h[4]
        mul     v5.8h, v29.8h, v12.h[2]
        mls     v18.8h, v11.8h, v7.h[0]
        mls     v5.8h, v20.8h, v7.h[0]
        sqdmulh v9.8h, v18.8h, v7.h[1]
        sqdmulh v0.8h, v5.8h, v7.h[1]
        mls     v22.8h, v6.8h, v7.h[0]
        srshr   v25.8h, v9.8h, #11
        mls     v8.8h, v13.8h, v7.h[0]
        srshr   v20.8h, v0.8h, #11
        mls     v18.8h, v25.8h, v7.h[0]
        mls     v5.8h, v20.8h, v7.h[0]
        sub     v2.8h, v22.8h, v8.8h
        add     v29.8h, v22.8h, v8.8h
        sqrdmulh        v26.8h, v2.8h, v12.h[1]
        str     q29, [x3], #64
        mul     v3.8h, v2.8h, v12.h[0]
        sub     v1.8h, v5.8h, v18.8h
        sqrdmulh        v20.8h, v1.8h, v12.h[1]
        mul     v15.8h, v1.8h, v12.h[0]
        mls     v3.8h, v26.8h, v7.h[0]
        mls     v15.8h, v20.8h, v7.h[0]
        add     v24.8h, v5.8h, v18.8h
        stur    q3, [x3, #-32]
        stur    q24, [x3, #-48]
        stur    q15, [x3, #-16]
        mov     x4, #0x4
        ldr     q0, [x1], #32
        ldur    q1, [x1, #-16]
        ldr     q28, [x0, #384]
        ldr     q26, [x0, #448]
        ldr     q3, [x0, #320]
        ldr     q13, [x0, #256]
        sub     v21.8h, v28.8h, v26.8h
        add     v20.8h, v28.8h, v26.8h
        sub     v26.8h, v13.8h, v3.8h
        add     v5.8h, v13.8h, v3.8h
        sqrdmulh        v28.8h, v21.8h, v1.h[5]
        sub     v2.8h, v5.8h, v20.8h
        mul     v11.8h, v26.8h, v1.h[2]
        sqrdmulh        v26.8h, v26.8h, v1.h[3]
        mul     v4.8h, v21.8h, v1.h[4]
        mls     v4.8h, v28.8h, v7.h[0]
        mls     v11.8h, v26.8h, v7.h[0]
        sqrdmulh        v28.8h, v2.8h, v0.h[5]
        sub     v24.8h, v11.8h, v4.8h
        mul     v6.8h, v24.8h, v0.h[4]
        sub     x4, x4, #0x1

layer123_start:
        sqrdmulh        v24.8h, v24.8h, v0.h[5]
        ldr     q29, [x0, #128]
        ldr     q9, [x0, #192]
        ldr     q19, [x0]
        ldr     q18, [x0, #64]
        mul     v3.8h, v2.8h, v0.h[4]
        add     v17.8h, v5.8h, v20.8h
        mls     v3.8h, v28.8h, v7.h[0]
        add     v2.8h, v29.8h, v9.8h
        mls     v6.8h, v24.8h, v7.h[0]
        sub     v20.8h, v19.8h, v18.8h
        add     v25.8h, v19.8h, v18.8h
        sub     v24.8h, v29.8h, v9.8h
        mul     v10.8h, v20.8h, v0.h[6]
        sub     v27.8h, v25.8h, v2.8h
        add     v12.8h, v25.8h, v2.8h
        sqrdmulh        v19.8h, v20.8h, v0.h[7]
        add     v21.8h, v11.8h, v4.8h
        mul     v15.8h, v24.8h, v1.h[0]
        sub     v2.8h, v12.8h, v17.8h
        add     v16.8h, v12.8h, v17.8h
        mul     v25.8h, v27.8h, v0.h[2]
        sqrdmulh        v24.8h, v24.8h, v1.h[1]
        mls     v10.8h, v19.8h, v7.h[0]
        sqrdmulh        v5.8h, v2.8h, v0.h[1]
        mls     v15.8h, v24.8h, v7.h[0]
        ldr     q24, [x0, #464]
        mul     v4.8h, v2.8h, v0.h[0]
        mls     v4.8h, v5.8h, v7.h[0]
        sub     v28.8h, v10.8h, v15.8h
        sqrdmulh        v23.8h, v27.8h, v0.h[3]
        add     v31.8h, v10.8h, v15.8h
        sub     v18.8h, v31.8h, v21.8h
        mul     v10.8h, v28.8h, v0.h[2]
        str     q4, [x0, #256]
        ldr     q13, [x0, #400]
        sqrdmulh        v12.8h, v18.8h, v0.h[1]
        ldr     q17, [x0, #272]
        add     v9.8h, v31.8h, v21.8h
        sqrdmulh        v21.8h, v28.8h, v0.h[3]
        ldr     q4, [x0, #336]
        mls     v25.8h, v23.8h, v7.h[0]
        sub     v8.8h, v13.8h, v24.8h
        sqrdmulh        v19.8h, v8.8h, v1.h[5]
        sub     v14.8h, v17.8h, v4.8h
        mls     v10.8h, v21.8h, v7.h[0]
        add     v23.8h, v25.8h, v3.8h
        sub     v31.8h, v25.8h, v3.8h
        mul     v11.8h, v14.8h, v1.h[2]
        sqrdmulh        v27.8h, v31.8h, v0.h[1]
        sub     v2.8h, v10.8h, v6.8h
        add     v5.8h, v17.8h, v4.8h
        mul     v29.8h, v31.8h, v0.h[0]
        add     v20.8h, v13.8h, v24.8h
        add     v21.8h, v10.8h, v6.8h
        sqrdmulh        v4.8h, v2.8h, v0.h[1]
        mul     v3.8h, v2.8h, v0.h[0]
        sub     v2.8h, v5.8h, v20.8h
        sqrdmulh        v24.8h, v14.8h, v1.h[3]
        mls     v3.8h, v4.8h, v7.h[0]
        mul     v4.8h, v8.8h, v1.h[4]
        mls     v11.8h, v24.8h, v7.h[0]
        mls     v29.8h, v27.8h, v7.h[0]
        mls     v4.8h, v19.8h, v7.h[0]
        mul     v17.8h, v18.8h, v0.h[0]
        str     q29, [x0, #384]
        mls     v17.8h, v12.8h, v7.h[0]
        str     q3, [x0, #448]
        str     q16, [x0], #16
        sub     v24.8h, v11.8h, v4.8h
        str     q9, [x0, #48]
        sqrdmulh        v28.8h, v2.8h, v0.h[5]
        str     q23, [x0, #112]
        str     q21, [x0, #176]
        mul     v6.8h, v24.8h, v0.h[4]
        str     q17, [x0, #304]
        sub     x4, x4, #0x1
        cbnz    x4, layer123_start

        ldr     q9, [x0]
        sqrdmulh        v25.8h, v24.8h, v0.h[5]
        ldr     q21, [x0, #192]
        ldr     q16, [x0, #64]
        mul     v30.8h, v2.8h, v0.h[4]
        ldr     q17, [x0, #128]
        mls     v30.8h, v28.8h, v7.h[0]
        add     v15.8h, v9.8h, v16.8h
        sub     v18.8h, v17.8h, v21.8h
        mls     v6.8h, v25.8h, v7.h[0]
        add     v19.8h, v17.8h, v21.8h
        sub     v14.8h, v9.8h, v16.8h
        mul     v8.8h, v18.8h, v1.h[0]
        add     v27.8h, v15.8h, v19.8h
        sqrdmulh        v22.8h, v14.8h, v0.h[7]
        sqrdmulh        v3.8h, v18.8h, v1.h[1]
        add     v16.8h, v11.8h, v4.8h
        mul     v29.8h, v14.8h, v0.h[6]
        mls     v29.8h, v22.8h, v7.h[0]
        sub     v22.8h, v15.8h, v19.8h
        add     v26.8h, v5.8h, v20.8h
        mls     v8.8h, v3.8h, v7.h[0]
        sub     v21.8h, v27.8h, v26.8h
        add     v24.8h, v27.8h, v26.8h
        sqrdmulh        v23.8h, v22.8h, v0.h[3]
        str     q24, [x0], #16
        mul     v13.8h, v22.8h, v0.h[2]
        sub     v25.8h, v29.8h, v8.8h
        add     v18.8h, v29.8h, v8.8h
        mul     v14.8h, v21.8h, v0.h[0]
        add     v26.8h, v18.8h, v16.8h
        sqrdmulh        v31.8h, v25.8h, v0.h[3]
        mls     v13.8h, v23.8h, v7.h[0]
        str     q26, [x0, #48]
        sub     v12.8h, v18.8h, v16.8h
        mul     v2.8h, v25.8h, v0.h[2]
        mls     v2.8h, v31.8h, v7.h[0]
        mul     v10.8h, v12.8h, v0.h[0]
        sub     v3.8h, v13.8h, v30.8h
        add     v19.8h, v13.8h, v30.8h
        sqrdmulh        v28.8h, v3.8h, v0.h[1]
        sub     v18.8h, v2.8h, v6.8h
        str     q19, [x0, #112]
        sqrdmulh        v23.8h, v12.8h, v0.h[1]
        add     v26.8h, v2.8h, v6.8h
        sqrdmulh        v17.8h, v18.8h, v0.h[1]
        sqrdmulh        v30.8h, v21.8h, v0.h[1]
        mls     v10.8h, v23.8h, v7.h[0]
        mul     v18.8h, v18.8h, v0.h[0]
        str     q26, [x0, #176]
        mls     v14.8h, v30.8h, v7.h[0]
        str     q10, [x0, #304]
        mls     v18.8h, v17.8h, v7.h[0]
        mul     v23.8h, v3.8h, v0.h[0]
        str     q14, [x0, #240]
        mls     v23.8h, v28.8h, v7.h[0]
        str     q18, [x0, #432]
        str     q23, [x0, #368]
        ldp     d8, d9, [sp]
        ldp     d10, d11, [sp, #16]
        ldp     d12, d13, [sp, #32]
        ldp     d14, d15, [sp, #48]
        add     sp, sp, #0x40
        ret
